# Dynamic Payment Amount Fix üéâ

## Problem
Razorpay payments were hardcoded to ‚Çπ2000 regardless of the actual order details. The payment amount should be calculated dynamically based on:
- Garment type
- Fabric cost (if shop fabric selected)
- Embroidery cost (if embroidery enabled)
- Urgency charges (if urgent delivery selected)

## Root Causes Identified

### 1. Authentication Middleware Missing ‚ùå
Several portal routes were missing `auth` middleware, causing `req.user` to be `undefined`:
- `/api/portal/dashboard`
- `/api/portal/profile`
- `/api/portal/measurements`
- `/api/portal/orders`
- `/api/portal/appointments`

**Error seen in logs:**
```
‚ùå Profile route error: TypeError: Cannot read properties of undefined (reading 'id')
```

### 2. Order totalAmount Not Calculated ‚ùå
The backend order creation route was expecting an `items` array to calculate `totalAmount`, but the frontend was sending garment details without items. This resulted in `totalAmount` always being 0.

### 3. Static Test Bills ‚ùå
Bills were being created in "test mode" with hardcoded amounts of ‚Çπ2000.

---

## Solutions Implemented ‚úÖ

### 1. Added Auth Middleware to Portal Routes
**File:** `backend/routes/portal.js`

Fixed all portal routes to include authentication:
```javascript
router.get('/dashboard', auth, allowRoles('Customer'), async (req, res) => { ... });
router.get('/profile', auth, allowRoles('Customer'), async (req, res) => { ... });
router.get('/measurements', auth, allowRoles('Customer'), async (req, res) => { ... });
router.get('/orders', auth, allowRoles('Customer'), async (req, res) => { ... });
router.get('/appointments', auth, allowRoles('Customer'), async (req, res) => { ... });
```

### 2. Dynamic Total Amount Calculation
**File:** `backend/routes/portal.js` (lines 375-549)

Implemented comprehensive price calculation in the order creation endpoint:

```javascript
// Base prices by garment type
const basePrices = {
  'shirt': 800,
  'pants': 600,
  'suit': 2000,
  'dress': 1200,
  'kurta': 1000,
  'blouse': 800,
  'lehenga': 2500,
  'jacket': 1500,
  'other': 1000
};

// Fabric cost calculation
if (fabric.source === 'shop') {
  fabricCost = unitPrice * quantity;
}

// Embroidery cost calculation
if (embroidery.enabled) {
  const typeCharge = embTypes[type];
  const placementCharge = placements.reduce(...);
  const colorCharge = (colors.length - 1) * 50;
  embroideryCost = typeCharge + placementCharge + colorCharge;
}

// Urgency charge
const urgencyCharge = urgency === 'urgent' ? 500 : 0;

// Final total
const totalAmount = basePrice + fabricCost + embroideryCost + urgencyCharge;
```

### 3. Auto-Generate Bill with Order
**File:** `backend/routes/portal.js` (lines 517-535)

Bills are now automatically generated when a customer creates an order:

```javascript
// Auto-generate bill for the order
const Bill = require('../models/Bill');
const bill = await Bill.create({
  order: order._id,
  customer: customer._id,
  amount: totalAmount,  // ‚úÖ Dynamic amount based on order
  paymentMethod: 'Razorpay',
  status: 'Pending',
  amountPaid: 0,
  payments: [],
});

res.status(201).json({ 
  order: {
    ...order.toObject(),
    bill: bill._id  // Return bill ID for immediate payment
  }
});
```

### 4. Frontend Update
**File:** `frontend/src/pages/portal/NewOrder.js` (lines 467-475)

Updated frontend to use the automatically generated bill:

```javascript
const { data: orderRes } = await axios.post('/api/portal/orders', payload);

// Bill is now auto-generated by backend
const billId = orderRes?.order?.bill || '';
const billAmount = orderRes?.order?.totalAmount || getTotalPrice();
```

---

## Price Calculation Examples

### Example 1: Simple Shirt
- Base price (shirt): ‚Çπ800
- Own fabric: ‚Çπ0
- No embroidery: ‚Çπ0
- Normal delivery: ‚Çπ0
- **Total: ‚Çπ800** ‚úÖ

### Example 2: Lehenga with Shop Fabric
- Base price (lehenga): ‚Çπ2,500
- Fabric: 5m @ ‚Çπ300/m = ‚Çπ1,500
- No embroidery: ‚Çπ0
- Normal delivery: ‚Çπ0
- **Total: ‚Çπ4,000** ‚úÖ

### Example 3: Blouse with Full Embroidery (Urgent)
- Base price (blouse): ‚Çπ800
- Fabric: 2m @ ‚Çπ200/m = ‚Çπ400
- Embroidery:
  - Hand embroidery: ‚Çπ800
  - Full garment placement: ‚Çπ1,200
  - 3 colors (2 extra): ‚Çπ100
  - Subtotal: ‚Çπ2,100
- Urgent delivery: ‚Çπ500
- **Total: ‚Çπ3,800** ‚úÖ

### Example 4: Suit with Shop Fabric & Embroidery
- Base price (suit): ‚Çπ2,000
- Fabric: 4m @ ‚Çπ400/m = ‚Çπ1,600
- Embroidery:
  - Zardosi work: ‚Çπ1,200
  - Collar + Sleeves: ‚Çπ350
  - 2 colors (1 extra): ‚Çπ50
  - Subtotal: ‚Çπ1,600
- Normal delivery: ‚Çπ0
- **Total: ‚Çπ5,200** ‚úÖ

---

## Embroidery Pricing Details

### Embroidery Types
- Machine: ‚Çπ300
- Hand: ‚Çπ800
- Zardosi: ‚Çπ1,200
- Aari: ‚Çπ1,000
- Bead work: ‚Çπ900
- Thread work: ‚Çπ500

### Placement Charges
- Collar: ‚Çπ150
- Sleeves: ‚Çπ200
- Neckline: ‚Çπ250
- Hem: ‚Çπ300
- Full garment: ‚Çπ1,200
- Custom: ‚Çπ300

### Color Charges
- First color: Included in base
- Each additional color: ‚Çπ50

---

## Testing Checklist

### Backend Testing ‚úÖ
- [x] Auth middleware properly applied
- [x] Order creation calculates correct totalAmount
- [x] Bill auto-generated with correct amount
- [x] All garment types have correct base prices
- [x] Fabric cost calculated correctly
- [x] Embroidery cost calculated correctly
- [x] Urgency charge applied correctly

### Frontend Testing ‚úÖ
- [x] Order submission sends all required data
- [x] Bill ID received from backend
- [x] Payment amount matches order total
- [x] Razorpay payment modal shows correct amount
- [x] Payment success updates bill status

### Integration Testing üîÑ
Test the complete flow:
1. Register/Login as customer ‚úÖ
2. Create new order with different configurations ‚úÖ
3. Verify totalAmount calculation ‚úÖ
4. Proceed to payment ‚úÖ
5. Verify Razorpay shows correct amount ‚úÖ
6. Complete payment ‚úÖ
7. Verify order and bill status updated ‚úÖ

---

## API Endpoints Updated

### POST `/api/portal/orders`
**Before:**
```json
{
  "items": [],
  "totalAmount": 0  // ‚ùå Always 0
}
```

**After:**
```json
{
  "garmentType": "blouse",
  "fabric": { "source": "shop", "fabricId": "...", "quantity": 2 },
  "embroidery": { "enabled": true, "type": "hand", "placements": ["collar"] },
  "urgency": "urgent",
  "totalAmount": 3800  // ‚úÖ Dynamically calculated
}
```

### Response Includes Bill
```json
{
  "order": {
    "_id": "...",
    "totalAmount": 3800,
    "bill": "bill_id_123",  // ‚úÖ Auto-generated bill
    ...
  }
}
```

---

## Console Logs for Debugging

The backend now includes detailed logging:
```
üìù Creating order with data: { garmentType, urgency, fabric, embroidery }
üí∞ Base price for blouse : 800
üßµ Fabric cost: 400 ( 2 m @ 200 /m)
‚ú® Embroidery cost: 2100
‚ö° Urgency charge: 500
üíµ Total amount: 3800 = base: 800 + fabric: 400 + embroidery: 2100 + urgency: 500
üí≥ Bill generated: 67890... Amount: 3800
‚úÖ Order created: 12345... Total: 3800
```

---

## Files Modified

1. ‚úÖ `backend/routes/portal.js` - Order creation & price calculation
2. ‚úÖ `frontend/src/pages/portal/NewOrder.js` - Use auto-generated bill
3. ‚úÖ All auth middleware properly applied

---

## Benefits

‚úÖ **Dynamic Pricing**: Payment amount reflects actual order configuration
‚úÖ **Accurate Billing**: Bills match order totals
‚úÖ **Better UX**: Customers see correct amounts throughout the flow
‚úÖ **Secure**: Auth middleware prevents unauthorized access
‚úÖ **Maintainable**: Single source of truth for price calculation
‚úÖ **Scalable**: Easy to add new garment types or modify prices

---

## Next Steps (Optional Enhancements)

1. üîß Add price configuration in database for easy updates
2. üìä Add discount codes/promotions support
3. üí∞ Add tax calculation (GST)
4. üìß Send order confirmation emails with price breakdown
5. üßæ Generate PDF invoices with itemized pricing
6. üìà Admin dashboard to update base prices

---

## Verification Commands

```bash
# Backend is running
curl http://localhost:5000/api/portal/profile -H "Authorization: Bearer YOUR_TOKEN"

# Should now return user data instead of "Cannot read properties of undefined"
```

---

**Status**: ‚úÖ **COMPLETE - All Issues Fixed!**

The Razorpay payment amount is now fully dynamic and calculated based on:
- Garment type base prices
- Selected fabric and quantity
- Embroidery customizations
- Delivery urgency

Customers will now see accurate pricing throughout the order flow! üéâ

